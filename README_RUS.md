# Telegram-бот для загрузки аудио и видео с YouTube

Этот проект представляет собой Telegram-бота, написанного на Python, который позволяет пользователям загружать аудио и видео с YouTube. Пользователи могут отправлять боту ссылки на YouTube, выбирать желаемый формат и качество, и получать загруженные медиафайлы прямо в чат Telegram.

## Основные возможности

*   **Загрузка с YouTube:** Скачивание аудио и видео по ссылкам.
*   **Выбор формата:** Пользователи могут выбирать между различными качествами видео (144p, 240p, 360p, 480p, 720p, 1080p) и аудио в формате MP3.
*   **Проверка подписки:** Бот проверяет, подписан ли пользователь на указанные в конфигурации каналы Telegram, прежде чем разрешить загрузку.
*   **Управление cookie:** Автоматическое обновление cookie для YouTube каждые 12 часов для обеспечения доступа.
*   **Контроль одновременных загрузок:** Использование Redis для предотвращения нескольких одновременных загрузок одним и тем же пользователем.
*   **Управление пользователями:** Хранение информации о пользователях в базе данных PostgreSQL.
*   **Обработка больших файлов:** Файлы размером более 50 МБ загружаются на отдельный сервер хранения через SFTP, а пользователь получает публичную ссылку для скачивания.
*   **Административные команды:** Команды для проверки состояния бота, просмотра активных блокировок и ручного обновления cookie.

## Технологии

*   **Python:** Основной язык программирования.
*   **aiogram:** Асинхронный фреймворк для Telegram Bot API.
*   **yt-dlp:** Утилита командной строки для загрузки видео с YouTube и других сайтов.
*   **APScheduler:** Планировщик задач для периодического обновления cookie.
*   **Redis:** Хранилище данных в памяти для управления блокировками загрузок.
*   **PostgreSQL:** Объектно-реляционная СУБД для хранения данных пользователей.
*   **asyncssh:** Библиотека для работы с SSH (используется для SFTP).
*   **Docker & Docker Compose:** Для контейнеризации и оркестрации всего приложения.

## Архитектура проекта

Проект имеет следующую структуру:

*   `main.py`: Точка входа в приложение. Инициализирует бота, базу данных и планировщик.
*   `audio.py`: Содержит основную бизнес-логику, включая обработку ссылок, загрузку медиа и управление взаимодействием с пользователем.
*   `handlers/bot.py`: Определяет обработчики команд и сообщений от пользователя, управляет состоянием диалога (FSM).
*   `config.py`: Управляет загрузкой конфигурации из переменных окружения.
*   `constants.py`: Содержит константы, такие как доступные форматы загрузки.
*   `generate_cookies.py`: Скрипт для извлечения cookie-файлов YouTube из браузера.
*   `redis_lock.py`: Реализует логику блокировок на основе Redis.
*   `web_server.py`: Простой веб-сервер, который может быть использован для предоставления доступа к файлам.
*   `clients/`: Каталог с клиентами для взаимодействия с внешними сервисами:
    *   `async_user_actioner.py`: Для работы с данными пользователей в БД.
    *   `pg_client.py`: Низкоуровневый клиент для подключения к PostgreSQL.
    *   `storage_client.py`: Клиент для загрузки файлов на сервер хранения по SFTP.
*   `docker-compose.yml`: Определяет сервисы, необходимые для работы бота: основной контейнер приложения, базу данных PostgreSQL и кэш Redis.
*   `Dockerfile`: Описывает, как собрать образ Docker для основного приложения бота.

## Установка и запуск

### Предварительные требования

*   Docker
*   Docker Compose

### Настройка

1.  **Создайте файл `.env`** в корне проекта. Вы можете скопировать `.env.example` (если он есть) или создать новый. Файл должен содержать следующие переменные:

    ```bash
    TOKEN="ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН"
    ADMIN_CHAT_ID=ВАШ_АДМИН_ЧАТ_ID
    ADMIN_USER_ID=ВАШ_АДМИН_USER_ID
    DB_DSN="postgresql://user:password@host:port/database"
    REQUIRED_CHANNELS="канал1,канал2" # Опционально, через запятую

    # Настройки для сервера хранения (SFTP)
    STORAGE_HOST="ip_адрес_сервера"
    STORAGE_PORT=22
    STORAGE_USER="имя_пользователя"
    STORAGE_PASSWORD="пароль" # или используйте ключ
    STORAGE_PRIVATE_KEY_PATH="/path/to/your/private/key" # если используется аутентификация по ключу
    STORAGE_REMOTE_PATH="/remote/path/for/uploads/"
    STORAGE_PUBLIC_URL_PREFIX="https://your-domain.com/downloads/"
    ```

2.  **Cookie-файл YouTube:** Для загрузки некоторых видео (например, с возрастными ограничениями) требуется cookie-файл.
    *   Запустите скрипт `generate_cookies.py` локально, чтобы сгенерировать `www.youtube.com_cookies.txt`.
    *   Поместите этот файл в корень проекта. Он будет скопирован в Docker-контейнер.

3.  **SSH-ключ (опционально):** Если вы используете аутентификацию по ключу для SFTP, убедитесь, что путь к приватному ключу, указанный в `.env`, корректен, и `docker-compose.yml` настроен для его монтирования в контейнер.

### Запуск

Выполните команду в корневой директории проекта:

```bash
docker-compose up -d --build
```

Эта команда соберет Docker-образы и запустит все необходимые сервисы в фоновом режиме.

## Логика работы

1.  **Получение ссылки:** Пользователь отправляет боту ссылку на видео YouTube.
2.  **Проверка подписки:** Бот проверяет, является ли пользователь подписчиком каналов, указанных в `REQUIRED_CHANNELS`.
3.  **Выбор формата:** Бот использует `yt-dlp` для получения информации о доступных форматах и их размерах, после чего предлагает пользователю сделать выбор с помощью inline-клавиатуры.
4.  **Процесс загрузки:**
    *   Перед началом загрузки бот устанавливает блокировку для пользователя в Redis, чтобы избежать параллельных скачиваний.
    *   Выбранный формат загружается с помощью `yt-dlp`.
5.  **Отправка файла:**
    *   **Если файл < 50 МБ:** Он отправляется напрямую пользователю через Telegram API.
    *   **Если файл > 50 МБ:**
        *   Файл загружается на внешний сервер хранения с помощью `storage_client.py` по протоколу SFTP.
        *   После успешной загрузки бот формирует публичную ссылку на файл (используя `STORAGE_PUBLIC_URL_PREFIX`) и отправляет ее пользователю.
6.  **Завершение:** После отправки файла или ссылки блокировка в Redis снимается.

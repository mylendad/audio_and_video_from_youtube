name: CD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: 'main'

    - name: Create .env file locally
      run: |
        echo "Creating .env file on the runner..."
        cat << EOF > .env
        TOKEN=${{ secrets.TOKEN }}
        ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }}
        ADMIN_USER_ID=${{ secrets.ADMIN_USER_ID }}
        DB_DSN=${{ secrets.DB_DSN }}
        REQUIRED_CHANNELS='${{ secrets.REQUIRED_CHANNELS }}'
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        WEB_SERVER_PORT=${{ secrets.WEB_SERVER_PORT }}
        STORAGE_HOST=${{ secrets.STORAGE_HOST }}
        STORAGE_PORT=${{ secrets.STORAGE_PORT }}
        STORAGE_USER=${{ secrets.STORAGE_USER }}
        STORAGE_PASSWORD=${{ secrets.STORAGE_PASSWORD }}
        STORAGE_PRIVATE_KEY_PATH=${{ secrets.STORAGE_PRIVATE_KEY_PATH }}
        STORAGE_PUBLIC_URL_PREFIX=${{ secrets.STORAGE_PUBLIC_URL_PREFIX }}
        SSH_KEY_HOST_PATH=${{ secrets.STORAGE_KEY_SERVER_PATH }}
        STORAGE_PATH=${{ secrets.STORAGE_PATH }}
        EOF
        echo ".env file created locally."

    - name: Clean up old version on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -e
          echo "Cleaning up deployment directory: ${{ secrets.DEPLOY_PATH }}"
          # Navigate to deploy path, creating it if it doesn't exist
          mkdir -p ${{ secrets.DEPLOY_PATH }}
          cd ${{ secrets.DEPLOY_PATH }}
          # Remove contents
          rm -rf *
          rm -rf .[^.]* ..?*
          echo "Cleanup complete."

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "."
        target: ${{ secrets.DEPLOY_PATH }}

    - name: Deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          echo "Ensuring www.youtube.com_cookies.txt exists..."
          rm -f www.youtube.com_cookies.txt
          touch www.youtube.com_cookies.txt
          
          echo "Running deployment commands..."
          ${{ secrets.DEPLOY_COMMANDS }}
          echo "Deployment finished."

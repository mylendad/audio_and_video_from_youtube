name: CD

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production 
    # This job requires secrets to be set in your GitHub repository settings.
    # Go to Settings > Secrets and variables > Actions to add them.─
    #
    # Required secrets:
    # - SSH_HOST: The IP address or hostname of your server.
    # - SSH_USER: The username for SSH login.
    # - SSH_PORT: The port for SSH connection (default is 22)..github/workflows/cd.yml
    # - ENV_FILE: The content of your .env file.
    # - DEPLOY_PATH: The absolute path on the server where the project should be deployed (e.g., /home/user/app).
    # - DEPLOY_COMMANDS: The commands to run on the server after deployment (e.g., 'docker-compose up -d --build').
#feeff
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: 'main' 

    - name: Create .env file locally
      run: |
        echo "Creating .env file on the runner..."
        cat << EOF > .env
        TOKEN=${{ secrets.TOKEN }}
        ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }}
        ADMIN_USER_ID=${{ secrets.ADMIN_USER_ID }}
        DB_DSN=${{ secrets.DB_DSN }}
        REQUIRED_CHANNELS='${{ secrets.REQUIRED_CHANNELS }}'
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        WEB_SERVER_PORT=${{ secrets.WEB_SERVER_PORT }}
        STORAGE_HOST=${{ secrets.STORAGE_HOST }}
        STORAGE_PORT=${{ secrets.STORAGE_PORT }}
        STORAGE_USER=${{ secrets.STORAGE_USER }}
        STORAGE_PASSWORD=${{ secrets.STORAGE_PASSWORD }}
        STORAGE_PRIVATE_KEY_PATH=${{ secrets.STORAGE_PRIVATE_KEY_PATH }}
        STORAGE_PUBLIC_URL_PREFIX=${{ secrets.STORAGE_PUBLIC_URL_PREFIX }}
        SSH_KEY_HOST_PATH=${{ secrets.STORAGE_KEY_SERVER_PATH }}
        EOF
        echo ".env file created locally."

    - name: Clean up old version on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -e
          echo "Cleaning up deployment directory: ${{ secrets.DEPLOY_PATH }}"
          # Navigate to deploy path, creating it if it doesn't exist
          mkdir -p ${{ secrets.DEPLOY_PATH }}
          cd ${{ secrets.DEPLOY_PATH }}
          # Remove contents
          rm -rf *
          rm -rf .[^.]* ..?*
          echo "Cleanup complete."

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "."
        target: ${{ secrets.DEPLOY_PATH }}

    - name: Deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -e
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "--- DEBUG STEP ---"
          echo "Value of secret STORAGE_KEY_SERVER_PATH is: [${{ secrets.STORAGE_KEY_SERVER_PATH }}]"
          echo "--- END DEBUG STEP ---"
          
          echo "Creating SSH key file for storage access..."
          SSH_KEY_PATH_ON_SERVER="${{ secrets.STORAGE_KEY_SERVER_PATH }}"
          
          # Ensure the target directory for the key exists──
          SSH_KEY_DIR=$(dirname -- "$SSH_KEY_PATH_ON_SERVER")
          echo "Creating directory for SSH key: $SSH_KEY_DIR"
          mkdir -p -- "$SSH_KEY_DIR"
          
          # Create the key file
          echo "Writing SSH private key to $SSH_KEY_PATH_ON_SERVER"
          echo "${{ secrets.STORAGE_SSH_PRIVATE_KEY }}" > "$SSH_KEY_PATH_ON_SERVER"
          chmod 600 -- "$SSH_KEY_PATH_ON_SERVER"
          echo "SSH key file created and permissions set."

          echo "Ensuring www.youtube.com_cookies.txt exists..."
          rm -f www.youtube.com_cookies.txt
          touch www.youtube.com_cookies.txt
          
          echo "Running deployment commands..."
          ${{ secrets.DEPLOY_COMMANDS }}
          echo "Deployment finished."
